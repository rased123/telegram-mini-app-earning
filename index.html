<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monetag Earn App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); padding: 20px; text-align: center; }
        .balance-box { padding: 15px; border: 1px solid var(--tg-theme-hint-color); border-radius: 8px; margin-bottom: 20px; }
        .btn { background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <h2>üí∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</h2>
    <div class="balance-box">
        <p id="balance">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>

    <div id="monetag-ad-container" style="min-height: 100px; background: #333; color: white; padding: 10px;">
        Monetag Ad Code ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶∏‡¶¨‡ßá‡•§
    </div>

    <button class="btn" onclick="simulateAdView()">üì∫ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£</button>
    <button class="btn" onclick="openWithdrawal()">üí∏ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    
    <p id="message"></p>

    <script>
        const API_BASE_URL = window.location.origin + '/api'; 
        let userBalance = 0;

        window.onload = function() {
            if (window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                loadBalance();
            } else {
                document.getElementById('message').innerText = '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø Telegram ‡¶è ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
            }
        };

        async function loadBalance() {
            if (!window.Telegram.WebApp || !window.Telegram.WebApp.initDataUnsafe.user) return;
            const tgId = window.Telegram.WebApp.initDataUnsafe.user.id;
            const initData = window.Telegram.WebApp.initData;
            try {
                const response = await fetch(`${API_BASE_URL}/balance?tgId=${tgId}&initData=${initData}`);
                const data = await response.json();
                if (response.ok) {
                    userBalance = data.balance;
                    document.getElementById('balance').innerText = `${userBalance.toFixed(2)} BDT`;
                } else {
                    document.getElementById('balance').innerText = `‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${data.message}`;
                }
            } catch (error) {
                document.getElementById('balance').innerText = '‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡•§';
            }
        }

        async function simulateAdView() {
            document.getElementById('message').innerText = '‡¶Ü‡¶Ø‡¶º ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
            if (!window.Telegram.WebApp || !window.Telegram.WebApp.initDataUnsafe.user) {
                 document.getElementById('message').innerText = 'Telegram ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§'; return;
            }
            const initData = window.Telegram.WebApp.initData;
            const amount = 0.05; 
            try {
                const response = await fetch(`${API_BASE_URL}/record-earning`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData, amount })
                });
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('message').innerText = `‚úÖ ‡¶∏‡¶´‡¶≤! ${amount} BDT ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`;
                    loadBalance();
                } else {
                    document.getElementById('message').innerText = `‚ùå ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${data.message}`;
                }
            } catch (error) {
                document.getElementById('message').innerText = '‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡•§';
            }
        }

        function openWithdrawal() {
            const amountStr = prompt(`‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ${userBalance.toFixed(2)} BDT‡•§ ‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`);
            const amount = parseFloat(amountStr);
            if (amount && amount > 0) {
                 const details = prompt('‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏ (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞) ‡¶¶‡¶ø‡¶®:');
                 if (details) {
                     submitWithdrawal(amount, details);
                 }
            }
        }
        
        async function submitWithdrawal(amount, details) {
             document.getElementById('message').innerText = '‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
             if (!window.Telegram.WebApp || !window.Telegram.WebApp.initDataUnsafe.user) return;
             const initData = window.Telegram.WebApp.initData;
             try {
                const response = await fetch(`${API_BASE_URL}/submit-withdrawal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData, amount, details })
                });
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('message').innerText = `‚úÖ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡¶¨‡ßá‡•§`;
                    loadBalance(); 
                } else {
                    document.getElementById('message').innerText = `‚ùå ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${data.message}`;
                }
            } catch (error) {
                document.getElementById('message').innerText = '‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡•§';
            }
        }
    </script>
</body>
</html>
